import fs from "node:fs";
import path from "node:path";

const CONTENT_DIR = path.join(process.cwd(), "content");
const isWatchMode = process.argv.includes("--watch");

/**
 * Scans for demo folders containing index.tsx and styles.module.css,
 * then generates playground files.
 */
function findDemoFolders(dir: string): string[] {
  const demos: string[] = [];

  function walk(currentDir: string) {
    const entries = fs.readdirSync(currentDir, { withFileTypes: true });

    for (const entry of entries) {
      const fullPath = path.join(currentDir, entry.name);

      if (entry.isDirectory()) {
        if (entry.name === "demos") {
          const demoEntries = fs.readdirSync(fullPath, { withFileTypes: true });
          for (const demoEntry of demoEntries) {
            if (demoEntry.isDirectory()) {
              const demoPath = path.join(fullPath, demoEntry.name);
              const indexPath = path.join(demoPath, "index.tsx");
              const stylesPath = path.join(demoPath, "styles.module.css");

              if (fs.existsSync(indexPath) && fs.existsSync(stylesPath)) {
                demos.push(demoPath);
              }
            }
          }
        } else {
          walk(fullPath);
        }
      }
    }
  }

  walk(dir);
  return demos;
}

function escapeTemplateString(str: string): string {
  return str.replace(/\\/g, "\\\\").replace(/`/g, "\\`").replace(/\$/g, "\\$");
}

function toPascalCase(folderName: string): string {
  const withoutPrefix = folderName.replace(/^\d+-/, "");
  return `${withoutPrefix
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join("")}Playground`;
}

function transformForPlayground(code: string): string {
  let result = code;
  result = result.replace(/^"use client";\n*/m, "");
  result = result.replace(
    /export function \w+\(/,
    "export default function App(",
  );
  return result;
}

function generatePlayground(demoPath: string): void {
  const playgroundsDir = path.join(demoPath, "playgrounds");
  const indexPath = path.join(demoPath, "index.tsx");
  const stylesPath = path.join(demoPath, "styles.module.css");
  const outputPath = path.join(playgroundsDir, "index.ts");

  if (!fs.existsSync(playgroundsDir)) {
    fs.mkdirSync(playgroundsDir, { recursive: true });
  }

  const demoName = path.basename(demoPath);
  const exportName = toPascalCase(demoName);

  const rawCode = fs.readFileSync(indexPath, "utf-8");
  const appCode = transformForPlayground(rawCode);
  const stylesCode = fs.readFileSync(stylesPath, "utf-8");

  const output = `// Auto-generated by scripts/generate-playgrounds.ts

export const ${exportName} = {
  files: {
    "/App.tsx": \`${escapeTemplateString(appCode)}\`,
    "/styles.module.css": \`${escapeTemplateString(stylesCode)}\`,
  },
};
`;

  fs.writeFileSync(outputPath, output);
  const relative = path.relative(process.cwd(), outputPath);
  console.log(`${isWatchMode ? "[regenerated]" : "Generated:"} ${relative}`);
}

function watchDemos(demos: string[]) {
  console.log("\nWatching for changes... (Ctrl+C to stop)\n");

  const watchers = new Map<string, fs.FSWatcher>();

  for (const demoPath of demos) {
    const indexPath = path.join(demoPath, "index.tsx");
    const stylesPath = path.join(demoPath, "styles.module.css");

    const handleChange = () => {
      try {
        generatePlayground(demoPath);
      } catch (err) {
        console.error(`Error regenerating ${demoPath}:`, err);
      }
    };

    // Watch both files
    for (const filePath of [indexPath, stylesPath]) {
      if (fs.existsSync(filePath)) {
        const watcher = fs.watch(filePath, { persistent: true }, (event) => {
          if (event === "change") {
            handleChange();
          }
        });
        watchers.set(filePath, watcher);
      }
    }
  }

  // Handle cleanup
  process.on("SIGINT", () => {
    console.log("\nStopping watch mode...");
    for (const watcher of watchers.values()) {
      watcher.close();
    }
    process.exit(0);
  });
}

function main() {
  console.log("Scanning for playground demos...\n");

  const demos = findDemoFolders(CONTENT_DIR);

  if (demos.length === 0) {
    console.log("No demos found with index.tsx and styles.module.css files.");
    return;
  }

  console.log(`Found ${demos.length} demo(s):\n`);

  for (const demoPath of demos) {
    generatePlayground(demoPath);
  }

  if (isWatchMode) {
    watchDemos(demos);
  } else {
    console.log("\nDone!");
  }
}

main();
